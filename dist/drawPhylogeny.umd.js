!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("d3")):"function"==typeof define&&define.amd?define(["d3"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).lwPhyloPlot=e(t.d3)}(this,function(t){"use strict";function e(t){var e=Object.create(null);return t&&Object.keys(t).forEach(function(n){if("default"!==n){var a=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,a.get?a:{enumerable:!0,get:function(){return t[n]}})}}),e.default=t,Object.freeze(e)}var n=e(t);function a(t,e,n,a){return{x:t+n*Math.cos(a),y:e-n*Math.sin(a)}}function r(t,e,n,r,i){const s=2*Math.PI,l=t=>(t%s+s)%s;let o=l(r),c=l(i);if((o-c+s)%s<(c-o+s)%s){const t=o;o=c,c=t}const h=(c-o+s)%s;if(h<1e-9){const r=a(t,e,n,o);return`M ${r.x} ${r.y}`}const d=h>Math.PI?1:0,p=a(t,e,n,o),f=a(t,e,n,c);return`M ${p.x} ${p.y} A ${n} ${n} 0 ${d} 0 ${f.x} ${f.y}`}function i(t,e=[]){e.push(t);for(let n=0;n<(t.children?.length||0);n++)e=i(t.children[n],e);return e}function s(t,e=!0){var n=[];for(const e of i(t))null===e.parent?n.push({parentId:null,parentLabel:null,thisId:e.id,thisLabel:e.label,children:e.children.map(t=>t.id),branchLength:0,isTip:!1,x:e.x,y:e.y,angle:e.angle}):n.push({parentId:e.parent.id,parentLabel:e.parent.label,thisId:e.id,thisLabel:e.label,children:e.children.map(t=>t.id),branchLength:e.branchLength,isTip:0==e.children.length,x:e.x,y:e.y,angle:e.angle});return e&&(n=n.sort(function(t,e){return t.thisId-e.thisId})),n}function l(t){const e=2*Math.PI,n=s(t,!0),a=new Map(n.map(t=>[t.thisId,t])),r=new Map(n.map(t=>[t.thisId,t.children||[]]));let i=null;for(const t of n)if(null==t.parentId){i=t.thisId;break}const l=[];!function t(e){const n=r.get(e)||[];if(0!==n.length)for(const e of n)t(e);else l.push(e)}(i);const o=Math.max(1,l.length),c=new Map;l.forEach((t,n)=>{c.set(t,n/o*e)}),function t(n){const a=r.get(n)||[];for(const e of a)t(e);if(a.length>0){let t=0,r=0;for(const e of a){const n=c.get(e);t+=Math.cos(n),r+=Math.sin(n)}c.set(n,(Math.atan2(r,t)%e+e)%e)}}(i);const h=new Map;h.set(i,0),function t(e){const n=r.get(e)||[],i=h.get(e)||0;for(const e of n){const n=a.get(e),r=n?.branchLength??0;h.set(e,i+r),t(e)}}(i);for(const t of n){const e=c.get(t.thisId)??0,n=h.get(t.thisId)??0;t.angle=e,t.r=n,t.x=n*Math.cos(e),t.y=n*Math.sin(e)}return n}function o(t){const e={};return e.data=l(t),e.radii=function(t){const e=l(t),n=new Map(e.map(t=>[t.thisId,t])),a=e.find(t=>null==t.parentId)?.thisId,r=[];for(const t of e){if(t.thisId===a)continue;const e=n.get(t.parentId);if(!e)continue;const i=t.angle,s=e.r,l=t.r;r.push({parentId:e.thisId,childId:t.thisId,x0:s*Math.cos(i),y0:s*Math.sin(i),x1:l*Math.cos(i),y1:l*Math.sin(i),isTip:!!t.isTip})}return r}(t),e.arcs=function(t){const e=2*Math.PI;new Map(t.map(t=>[t.thisId,t]));const n=new Map;let a=null;for(const e of t)null==e.parentId&&(a=e.thisId),n.has(e.parentId)||n.set(e.parentId,[]),n.get(e.parentId).push(e);const r=[];for(const i of t){const t=i.thisId;if(t===a)continue;const s=n.get(t)||[];if(s.length<2)continue;const l=s.map(t=>(t.angle%e+e)%e).sort((t,e)=>t-e),o=l[0],c=l[l.length-1],h=c-o,d=e-h;let p,f,u;h<=d?(p=o,f=c,u=h):(p=c,f=o,u=d),u<1e-6||!isFinite(i.r)||i.r<=0||r.push({start:p,end:f,radius:i.r,thisId:t,parentId:i.parentId})}return r}(e.data),e.child_arcs=function(t){const e=new Map(t.map(t=>[t.thisId,t])),n=[];for(const a of t){if(null==a.parentId)continue;const t=e.get(a.parentId);t&&n.push({parentId:t.thisId,childId:a.thisId,radius:t.r,start:t.angle,end:a.angle})}return n}(e.data),e}function c(t){const e=s(t),n=new Map(e.map((t,e)=>[t.thisId,e])),a=[];!function t(e){e.children&&0!==e.children.length?e.children.forEach(t):a.push(e.id)}(t);const r=new Map(a.map((t,e)=>[t,e+1]));return function t(a){const i=n.get(a.id);if(!a.children||0===a.children.length){const t=r.get(a.id);return e[i].y0=t,e[i].y1=t,t}const s=function(t){let e=0,n=0;for(let a of t)null!=a&&(a=+a)>=a&&(++e,n+=a);if(e)return n/e}(a.children.map(t));return e[i].y0=s,e[i].y1=s,s}(t),function t(a,r){const i=n.get(a.id),s=r??0,l=s+(e[i].branchLength??0);e[i].x0=s,e[i].x1=l,a.children&&a.children.length&&a.children.forEach(e=>t(e,l))}(t,0),e.map(t=>{const{y:e,x:n,angle:a,...r}=t;return r})}function h(t){const e=c(t),n=function(t){const e=c(t),n=new Map;for(const t of e){if(null==t.parentId)continue;const e=n.get(t.parentId);e?e.push(t):n.set(t.parentId,[t])}const a=[];for(const[t,e]of n.entries()){if(!e.length)continue;const n=e.map(t=>t.y0),r=Math.min(...n),i=Math.max(...n),s=e[0].x0;a.push({parentId:t,x0:s,x1:s,y0:r,y1:i,heights:i-r})}return a}(t),a=function(t){const e=c(t),n=new Map(e.map(t=>[t.thisId,t])),a=[];for(const t of e){if(null==t.parentId)continue;const e=n.get(t.parentId);if(!e)continue;const r=t.x0,i=t.y0,s=e.y0,l=Math.min(i,s),o=Math.max(i,s);a.push({parentId:t.parentId,childId:t.thisId,x:r,y0:l,y1:o})}return a}(t);new Map(e.map(t=>[t.thisId,t]));const r=e.filter(t=>null!=t.parentId).map(t=>({parentId:t.parentId,childId:t.thisId,thisId:t.thisId,thisLabel:t.thisLabel,isTip:t.isTip,x0:t.x0,x1:t.x1,y0:t.y0,y1:t.y0}));return{data:e,vertical_lines:n,child_vertical_lines:a,horizontal_lines:r}}function d(t){null===t.parent&&(function t(e){if(!e.children||0===e.children.length)return e.ntips=1,1;let n=0;for(const a of e.children)n+=t(a);return e.ntips=n,n}(t),t.start=0,t.end=2,t.angle=0,t.ntips=function(t){var e=0;for(const n of function(t){const e=[t],n=[];for(;e.length;){const t=e.shift();n.push(t);for(const n of t.children)e.push(n)}return n}(t))0==n.children.length&&e++;return e}(t),t.x=0,t.y=0);let e=t.start;for(let n=0;n<t.children.length;n++){const a=t.children[n],r=(t.end-t.start)*(a.ntips/t.ntips);a.start=e,a.end=e+r,a.angle=a.start+(a.end-a.start)/2,e=a.end;const i=a.angle*Math.PI,s=a.branchLength??0;a.x=t.x+s*Math.sin(i),a.y=t.y+s*Math.cos(i),d(a)}return t}function p(t){var e={},n=s(d(t));return e.data=n,e.edges=function(t,e=!1){const n=[...t].sort((t,e)=>t.thisId-e.thisId),a=new Map(n.map(t=>[t.thisId,t])),r=[];for(const t of n){if(null==t.parentId)continue;const n=a.get(t.parentId);n&&(e?(r.push({x1:t.x,y1:t.y,id1:t.thisId,x2:n.x,y2:t.y,id2:void 0}),r.push({x1:n.x,y1:t.y,id1:void 0,x2:n.x,y2:n.y,id2:t.parentId})):r.push({x1:t.x,y1:t.y,id1:t.thisId,x2:n.x,y2:n.y,id2:t.parentId}))}return r}(n),e}function f(t){const e=(t=String(t).replace(/\s+/g,"")).split(/(;|\(|\)|,)/),n={parent:null,children:[]};let a=n,r=0;for(const t of e)if(t&&";"!==t)if("("===t){const t={parent:a,children:[]};a.children.push(t),a=t}else if(","===t){a=a.parent;const t={parent:a,children:[]};a.children.push(t),a=t}else if(")"===t){if(a=a.parent,null===a)break}else{const e=t.split(":");1===e.length?t.startsWith(":")?(a.label="",a.branchLength=parseFloat(e[0])):(a.label=e[0],a.branchLength=null):2===e.length?(a.label=e[0],a.branchLength=parseFloat(e[1])):(console.warn(t,"Unhandled token with multiple ':' characters"),a.label=e[0]||"",a.branchLength=parseFloat(e[e.length-1])),a.id=r++}return null==n.id&&(n.id=r),n}return function(t,{layout:e="rect",width:a=800,height:i=800,margin:s={top:20,right:300,bottom:20,left:50},radialMargin:l=80,strokeWidth:c=1,radialMode:d="outer",tipLabels:u=!0,showTooltips:g=!0,tooltipFormatter:x=(t,e)=>`${t.thisLabel??"(unnamed)"}\nrootâ†’tip: ${(+e).toFixed(4)}`,hoverStroke:y="#1f77b4",hoverWidth:I=3,highlightTips:m=[],highlightStroke:M="#e63946",highlightWidth:b=2.5}={}){const w=t=>"number"==typeof t&&Number.isFinite(t);function k(t,{prefer:e="auto"}={}){return function(n){let a=t.get(n);if(!a)return 0;if("r"===e||"auto"===e&&"r"in a)return Number(a.r??0);if("x1"===e||"auto"===e&&"x1"in a)return Number(a.x1??0);let r=0;for(;a&&null!=a.parentId;)r+=Number(a.branchLength||0),a=t.get(a.parentId);return r}}if("rect"===e){const v=h(f(t)),_=v.horizontal_lines,L=v.vertical_lines,A=_.filter(t=>t.isTip),T=new Map(_.map(t=>[t.thisId,t])),j=new Map(A.map(t=>[t.thisId,t])),$=new Map(A.map(t=>[t.thisLabel,t])),P=k(T,{prefer:"x1"}),z=n.max(_,t=>t.y1),E=n.min(_,t=>t.y1),F=n.max(_,t=>t.x1),O=n.scaleLinear().domain([E-1,z+1]).range([s.top,i-s.bottom]),S=n.scaleLinear().domain([0,F]).range([s.left,a-s.right]),X=n.create("svg").attr("width",a).attr("height",i).attr("font-family","sans-serif").attr("font-size",10),Y=X.append("g"),N=X.append("g").attr("class","phylo_static_highlight"),W=X.append("g").attr("class","phylo_hover_highlight");Y.selectAll(".hline").data(_).join("line").attr("x1",t=>S(t.x0)).attr("y1",t=>O(t.y0)).attr("x2",t=>S(t.x1)).attr("y2",t=>O(t.y1)).attr("stroke","#555").attr("stroke-width",c),Y.selectAll(".vline").data(L).join("line").attr("x1",t=>S(t.x0)).attr("y1",t=>O(t.y0)).attr("x2",t=>S(t.x1)).attr("y2",t=>O(t.y1)).attr("stroke","#555").attr("stroke-width",c);const B=Y.selectAll(".tip-dot").data(A).join("circle").attr("cx",t=>S(t.x1)).attr("cy",t=>O(t.y1)).attr("r",2).attr("fill","black");if(g&&B.append("title").text(t=>x(t,P(t.thisId))),B.on("mouseenter",function(t,e){U(e.thisId,W,y,I),n.select(this).attr("r",4)}).on("mouseleave",function(){W.selectAll("*").remove(),n.select(this).attr("r",2)}),u){const q=X.append("g").attr("class","phylo_labels").selectAll("text").data(A).join("text").attr("x",t=>S(t.x1)+4).attr("y",t=>O(t.y1)).attr("dy","0.32em").attr("font-size",10).text(t=>t.thisLabel?.replace(/_/g," ")??"");g&&q.append("title").text(t=>x(t,P(t.thisId))),q.on("mouseenter",function(t,e){U(e.thisId,W,y,I),n.select(this).attr("font-weight",600)}).on("mouseleave",function(){W.selectAll("*").remove(),n.select(this).attr("font-weight",null)})}if(m&&m.length){new Set([...m.filter(w).map(t=>j.get(t)),...m.filter(t=>!w(t)).map(t=>$.get(t))].filter(Boolean)).forEach(t=>{U(t.thisId,N,M,b)})}function U(t,e,n,a){e.selectAll("*").remove();let r=T.get(t);for(;r&&null!=r.parentId;){const t=T.get(r.parentId);if(!t)break;e.append("line").attr("x1",S(r.x0)).attr("x2",S(r.x0)).attr("y1",O(t.y0)).attr("y2",O(r.y0)).attr("stroke",n).attr("stroke-width",a).attr("stroke-linecap","round"),e.append("line").attr("x1",S(r.x0)).attr("x2",S(r.x1)).attr("y1",O(r.y0)).attr("y2",O(r.y1)).attr("stroke",n).attr("stroke-width",a).attr("stroke-linecap","round"),r=t}}return X.node()}if("radial"===e){const D=o(f(t)),C="outer"===d,G=3,H=0,J=(n.max(D.data,t=>t.r)??0)+2*l,K=a,Q=i,R=K/2,V=Q/2,Z=n.scaleLinear().domain([-J,J]).range([0,K]),tt=n.scaleLinear().domain([-J,J]).range([Q,0]),et=t=>t*(K/(2*J)),nt=new Map(D.data.map(t=>[t.thisId,t])),at=D.data.filter(t=>t.isTip),rt=at.length?n.max(at,t=>t.r):0,it=k(nt,{prefer:"r"}),st=new Map(at.map(t=>[t.thisId,t])),lt=new Map(at.map(t=>[t.thisLabel,t]));function ot(t){return t.childId??t.thisId??t.id1??null}function ct(t,e,n,a){const r=Z(t),i=tt(e),s=Z(n)-r,l=tt(a)-i,o=Math.hypot(s,l)||1,c=Math.max(0,(o-H)/o);return{X0:r,Y0:i,X1s:r+s*c,Y1s:i+l*c,len:o}}const ht=n.create("svg").attr("width",K).attr("height",Q).attr("font-family","sans-serif").attr("font-size",10),dt=ht.append("g"),pt=ht.append("g").attr("class","phylo_static_lines"),ft=ht.append("g").attr("class","phylo_static_arcs"),ut=ht.append("g").attr("class","phylo_hover_lines"),gt=ht.append("g").attr("class","phylo_hover_arcs");dt.append("g").attr("class","phylo_arcs").selectAll("path").data(D.arcs).join("path").attr("d",t=>r(R,V,Math.max(0,et(t.radius)),t.start,t.end)).attr("fill","none").attr("stroke","#777").attr("stroke-width",c),dt.append("g").attr("class","phylo_radii").selectAll("line").data(D.radii).join("line").each(function(t,e){const a=t.x0,r=t.y0,i=ot(t),s=null!=i?nt.get(i):void 0,l=!(!s||!s.isTip);let o=t.x1,h=t.y1;C&&l&&(o=rt*Math.cos(s.angle),h=rt*Math.sin(s.angle));const{X0:d,Y0:p,X1s:f,Y1s:u}=ct(a,r,o,h);n.select(this).attr("x1",d).attr("y1",p).attr("x2",f).attr("y2",u).attr("stroke","#777").attr("stroke-width",c)});const xt=dt.append("g").attr("class","phylo_tip_dots").selectAll("circle").data(at).join("circle").each(function(t,e){const a=C?rt*Math.cos(t.angle):t.x,r=C?rt*Math.sin(t.angle):t.y;n.select(this).attr("cx",Z(a)).attr("cy",tt(r)).attr("r",G).attr("fill","black").attr("stroke","black").attr("stroke-width",1.5)});g&&xt.append("title").text(t=>x(t,it(t.thisId)));const yt=new Map(D.radii.map(t=>[ot(t),t])),It=new Map(D.child_arcs.map(t=>[t.childId,t]));if(u){const Mt=dt.append("g").attr("class","phylo_labels").selectAll("g.label").data(at).join("g").attr("class","label").attr("transform",t=>{const e=C?rt:t.r,n=e*Math.cos(t.angle),a=e*Math.sin(t.angle);return`translate(${Z(n)},${tt(a)})`}).each(function(t){let e=180*-t.angle/Math.PI,a=10,r="start";t.angle>Math.PI/2&&t.angle<3*Math.PI/2&&(e+=180,a*=-1,r="end"),n.select(this).append("g").attr("transform",`rotate(${e})`).append("text").attr("x",a).attr("alignment-baseline","middle").attr("text-anchor",r).attr("font-size",10).attr("fill","black").text(t=>t.thisLabel?.replace(/_/g," ")??"")});g&&Mt.append("title").text(t=>x(t,it(t.thisId))),Mt.on("mouseenter",function(t,e){mt(e,ut,gt,y,I),n.select(this).select("text").attr("font-weight",600)}).on("mouseleave",function(){ut.selectAll("*").remove(),gt.selectAll("*").remove(),n.select(this).select("text").attr("font-weight",null)})}function mt(t,e,n,a="#1f77b4",i=3){e.selectAll("*").remove(),n.selectAll("*").remove();let s="number"==typeof t?nt.get(t):t;if(!s)return;let l=!0;for(;s&&null!=s.parentId;){const t=yt.get(s.thisId);if(t){const n=t.x0,r=t.y0;let o=t.x1,c=t.y1;if(C&&l&&s.isTip){const t=rt;o=t*Math.cos(s.angle),c=t*Math.sin(s.angle)}const{X0:h,Y0:d,X1s:p,Y1s:f}=ct(n,r,o,c);e.append("line").attr("x1",h).attr("y1",d).attr("x2",p).attr("y2",f).attr("stroke",a).attr("stroke-width",i).attr("stroke-linecap","round")}const o=It.get(s.thisId);o&&n.append("path").attr("d",r(R,V,Math.max(0,et(o.radius)),o.start,o.end)).attr("fill","none").attr("stroke",a).attr("stroke-width",i),l=!1,s=nt.get(s.parentId)}}if(xt.on("mouseenter",function(t,e){mt(e,ut,gt,y,I),n.select(this).attr("r",G+2)}).on("mouseleave",function(){ut.selectAll("*").remove(),gt.selectAll("*").remove(),n.select(this).attr("r",G)}),m&&m.length){new Set([...m.filter(w).map(t=>st.get(t)),...m.filter(t=>!w(t)).map(t=>lt.get(t))].filter(Boolean)).forEach(t=>{mt(t.thisId,pt,ft,M,b)})}return ht.node()}if("unrooted"===e){const bt=p(f(t)),wt=a,kt=i,vt=n.extent(bt.data,t=>t.x),_t=n.extent(bt.data,t=>t.y),Lt=Math.max(Math.abs(vt[0]),Math.abs(vt[1])),At=Math.max(Math.abs(_t[0]),Math.abs(_t[1])),Tt=Math.max(Lt,At)+2*l,jt=n.scaleLinear().domain([-Tt,Tt]).range([0,wt]),$t=n.scaleLinear().domain([-Tt,Tt]).range([kt,0]),Pt=n.create("svg").attr("width",wt).attr("height",kt).attr("font-family","sans-serif").attr("font-size",10),zt=Pt.append("g"),Et=Pt.append("g").attr("class","phylo_static_highlight"),Ft=Pt.append("g").attr("class","phylo_hover_highlight");zt.append("g").attr("class","phylo_lines").selectAll("line").data(bt.edges).join("line").attr("x1",t=>jt(t.x1)).attr("y1",t=>$t(t.y1)).attr("x2",t=>jt(t.x2)).attr("y2",t=>$t(t.y2)).attr("stroke-width",c).attr("stroke","#777");const Ot=zt.append("g").attr("class","phylo_points").selectAll("circle").data(bt.data).join("circle").attr("class","dot").attr("r",t=>t.isTip?4:0).attr("cx",t=>jt(t.x)).attr("cy",t=>$t(t.y)).attr("stroke","black").attr("stroke-width",2).attr("fill",t=>t.isTip?"black":"white"),St=new Map(bt.data.map(t=>[t.thisId,t])),Xt=new Map(bt.data.filter(t=>t.isTip).map(t=>[t.thisId,t])),Yt=new Map(bt.data.filter(t=>t.isTip).map(t=>[t.thisLabel,t])),Nt=k(St,{prefer:"r"});g&&Ot.filter(t=>t.isTip).append("title").text(t=>x(t,Nt(t.thisId)));const Wt=new Map,Bt=new Map(bt.data.map(t=>[t.thisId,t]));if(bt.edges.forEach(t=>{const e=Bt.get(t.id1);e?.isTip&&Wt.set(t.id1,t)}),u){const qt=zt.append("g").attr("class","phylo_labels").selectAll("g").data(bt.data.filter(t=>t.isTip)).join("g").attr("transform",t=>`translate(${jt(t.x)},${$t(t.y)})`).each(function(t){const e=Wt.get(t.thisId);if(!e)return;const a=jt(e.x1),r=$t(e.y1),i=jt(e.x2)-a,s=$t(e.y2)-r;let l=180*Math.atan2(s,i)/Math.PI,o=-10,c="end";(l>90||l<-90)&&(l+=180,c="start",o=10),n.select(this).append("g").attr("transform",`rotate(${l})`).append("text").attr("x",o).attr("alignment-baseline","middle").attr("text-anchor",c).attr("font-size",10).attr("fill","black").text(t.thisLabel?.replace(/_/g," ")??"")});g&&qt.append("title").text(t=>x(t,Nt(t.thisId))),qt.on("mouseenter",function(t,e){Ut(e.thisId,Ft,y,I),n.select(this).select("text").attr("font-weight",600)}).on("mouseleave",function(){Ft.selectAll("*").remove(),n.select(this).select("text").attr("font-weight",null)})}if(Ot.filter(t=>t.isTip).on("mouseenter",function(t,e){Ut(e.thisId,Ft,y,I),n.select(this).attr("r",6)}).on("mouseleave",function(){Ft.selectAll("*").remove(),n.select(this).attr("r",4)}),m&&m.length){new Set([...m.filter(w).map(t=>Xt.get(t)),...m.filter(t=>!w(t)).map(t=>Yt.get(t))].filter(Boolean)).forEach(t=>{Ut(t.thisId,Et,M,b)})}function Ut(t,e,n,a){const r=new Map(bt.edges.map(t=>[t.id1,t]));e.selectAll("*").remove();let i=St.get(t);for(;i&&null!=i.parentId;){const t=r.get(i.thisId);t&&e.append("line").attr("x1",jt(t.x1)).attr("y1",$t(t.y1)).attr("x2",jt(t.x2)).attr("y2",$t(t.y2)).attr("stroke",n).attr("stroke-width",a).attr("stroke-linecap","round"),i=St.get(i.parentId)}}return Pt.node()}throw new Error("Unsupported layout type. Use 'rect', 'radial', or 'unrooted'.")}});
//# sourceMappingURL=drawPhylogeny.umd.js.map

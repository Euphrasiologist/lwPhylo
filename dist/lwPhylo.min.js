// https://github.com/Euphrasiologist/lwPhylo#readme v1.1.0 Copyright 2020 Max Brown
!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(n=n||self).lwphylo=t()}(this,(function(){"use strict";function n(n,t,r,e){return{x:n+r*Math.cos(e),y:t+r*Math.sin(e)}}var t={fortify:function(n,t=!0){var r=[];for(const t of function n(t,r=[]){r.push(t);for(var e=0;e<t.children.length;e++)r=n(t.children[e],r);return r}(n))null===t.parent?r.push({parentId:null,parentLabel:null,thisId:t.id,thisLabel:t.label,children:t.children.map(n=>n.id),branchLength:0,isTip:!1,x:t.x,y:t.y,angle:t.angle}):r.push({parentId:t.parent.id,parentLabel:t.parent.label,thisId:t.id,thisLabel:t.label,children:t.children.map(n=>n.id),branchLength:t.branchLength,isTip:0==t.children.length,x:t.x,y:t.y,angle:t.angle});return t&&(r=r.sort((function(n,t){return n.thisId-t.thisId}))),r},parentFisheye:function(n,t){for(let r=0;r<t.length;r++)if(n.parentId===t[r].thisId)return{px:t[r].fisheye.x,py:t[r].fisheye.y}},readTree:function(n){var t=(n=n.replace(/ \t/g,"")).split(/(;|\(|\)|,)/),r={parent:null,children:[]},e=r,a=0;for(const n of t)if(""!=n&&";"!=n)if("("==n){var i={parent:e,children:[]};e.children.push(i),e=i}else if(","==n){i={parent:e=e.parent,children:[]};e.children.push(i),e=i}else if(")"==n){if(null===(e=e.parent))break}else{var l=n.split(":");1==l.length?n.startsWith(":")?(e.label="",e.branchLength=parseFloat(l[0])):(e.label=l[0],e.branchLength=null):2==l.length?(e.label=l[0],e.branchLength=parseFloat(l[1])):console.warn(n,"I don't know what to do with two colons!"),e.id=a++}return e.id=a,r},subTree:function(n,t){let r={};n.data.forEach(n=>{r[n.thisId]={...n}});let e={};const a=function(n){r[n]&&(e[n]=r[n],r[n].children&&r[n].children.forEach(n=>{a(n)}))};a(t);const i=[["data",Object.values(e)]],l=i[0][1].map(n=>n.thisId);var h=[];for(const t in n)"data"!==t&&h.push([t,n[t]]);var s=h.map(n=>[n[0],n[1].filter(n=>l.includes(n.thisId))]);return Object.fromEntries(i.concat(s))}};function r(n){var r=t(n),e=t(n),a=1;for(let n=0;n<r.length;n++)1==r[n].isTip&&(r[n].angle=a/e*2*Math.PI,a+=1);function i(n,e){for(var a=0;a<r.length;a++){if(r[a].thisId===n)var i=r[a].angle;if(r[a].thisId===e)var l=r[a].angle}return t([i,l])}for(let n=0;n<r.length;n++)!1===r[n].isTip&&(r[n].angle=i(r[n].children[0],r[n].children[1]));var l=r.map(n=>null===n.parentId?n.thisId:null).filter(n=>null!=n)[0];function h(n){for(var t=0;t<r.length;t++)if(r[t].thisId===n)var e=r[t].r;return e}r.sort((n,t)=>t.thisId-n.thisId);for(let n=0;n<r.length;n++)if(r[n].parentId===l)!0===r[n].isTip?(r[n].r=r[n].branchLength,r[n].x=r[n].branchLength,r[n].y=0):(r[n].r=r[n].branchLength,r[n].x=r[n].branchLength*Math.cos(r[n].angle),r[n].y=r[n].branchLength*Math.sin(r[n].angle));else{var s=h(r[n].parentId);r[n].r=s+r[n].branchLength,r[n].x=(s+r[n].branchLength)*Math.cos(r[n].angle),r[n].y=(s+r[n].branchLength)*Math.sin(r[n].angle)}return r[0].r=0,r[0].x=0,r[0].y=0,r}function e(n,t){const r=Math.cos(n),e=Math.sin(n);return(a=Math.atan2(..."X"===t?[e,-r]:[-e,r])).toString().includes("3.1415")&&(a=Math.abs(a)),a;var a}var a={describeArc:function(t,r,e,a,i){var l=n(t,r,e,a),h=n(t,r,e,i);return["M",l.x,l.y,"A",e,e,0,0,0,h.x,h.y].join(" ")},radialLayout:function(n){var t={};return t.data=r(n),t.radii=function(n){var t=r(n);function e(n){for(var r=0;r<t.length;r++)if(t[r].thisId===n.parentId)var e=t[r].r;return e}for(var a=[],i=t.map(n=>null===n.parentId?n.thisId:null).filter(n=>null!=n)[0],l=0;l<t.length;l++)t[l].thisId!==i&&a.push({thisId:t[l].thisId,thisLabel:t[l].thisLabel,x0:t[l].x,x1:e(t[l])*Math.cos(t[l].angle),y0:t[l].y,y1:e(t[l])*Math.sin(t[l].angle),isTip:t[l].isTip});return a}(n),t.arcs=function(n){var t=[],r=n.map(n=>null===n.parentId?n.thisId:null).filter(n=>null!=n)[0];function a(t){for(var r=0;r<n.length;r++)if(n[r].parentId===t)var e=n[r].angle;return e}function i(t){for(var r=0;r<n.length;r++)if(n[r].thisId===t)var e=n[r].r;return e}for(let l=0;l<n.length;l++)n[l].thisId!==r&&t.push({start:e(Math.min(n[l].angle,a(n[l].parentId)),"Y"),end:e(Math.max(n[l].angle,a(n[l].parentId)),"Y"),radius:i(n[l].parentId),thisId:n[l].thisId,parentId:n[l].parentId});for(let n=0;n<t.length;n++)Math.sign(t[n].start)!==Math.sign(t[n].end)&&(t[n].end=Math.abs(t[n].end),t[n].start=-Math.abs(t[n].start));return t.filter(n=>n.start!==n.end&0!==n.radius)}(t.data),t}};function i(n){var r=t(n);r.map(n=>n.y=null);var e=1;for(let n=0;n<r.length;n++)!0===r[n].isTip&&(r[n].y0=e,r[n].y1=e,e+=1);function a(n,e){for(var a=0;a<r.length;a++){if(r[a].thisId===n)var i=r[a].y0;if(r[a].thisId===e)var l=r[a].y0}return t([i,l])}for(let n=0;n<r.length;n++)!1===r[n].isTip&&(r[n].y0=a(r[n].children[0],r[n].children[1]),r[n].y1=a(r[n].children[0],r[n].children[1]));var i=r.map(n=>null===n.parentId?n.thisId:null).filter(n=>null!=n)[0];function l(n){for(var t=0;t<r.length;t++)if(r[t].thisId===n)var e=r[t].x1;return e}r.sort((n,t)=>t.thisId-n.thisId);for(let n=0;n<r.length;n++)if(r[n].parentId===i)r[n].x0=0,r[n].x1=r[n].branchLength;else{var h=l(r[n].parentId);r[n].x0=h,r[n].x1=h+r[n].branchLength}return r.sort((n,t)=>n.thisId-t.thisId),r.map(({y:n,x:t,angle:r,...e})=>e)}return{phisheye:{phisheye:{circular:()=>{var n,t,r=200,e=2,a=[0,0],i={};function l(e){var l=i.xscale(e.x)-a[0],h=i.yscale(e.y)-a[1],s=Math.sqrt(l*l+h*h);if(!s||s>=r)return{x:i.xscale(e.x),y:i.yscale(e.y),z:s>=r?1:10};var d=n*(1-Math.exp(-s*t))/s*.75+.25;return{x:a[0]+l*d,y:a[1]+h*d,z:Math.min(d,10)}}function h(){return n=(n=Math.exp(e))/(n-1)*r,t=e/r,l}return l.radius=function(n){return arguments.length?(r=+n,h()):r},l.distortion=function(n){return arguments.length?(e=+n,h()):e},l.focus=function(n){return arguments.length?(a=n,l):a},l.scales=function(n,t){return arguments.length?(i={xscale:n,yscale:t},l):i},h()}}},radialLayout:a,describeArc:a,rectangleLayout:{rectangleLayout:function(n){var t={};return t.data=i(n),t.vertical_lines=function(n){var t=i(n);function r(n){for(var r=0;r<t.length;r++)if(t[r].parentId===n.parentId)var e=Math.abs(t[r].y0-n.y0);return e}for(var e=[],a=t.map(n=>null===n.parentId?n.thisId:null).filter(n=>null!=n)[0],l=0;l<t.length;l++)t[l].thisId!==a&&e.push({thisId:t[l].thisId,x0:t[l].x0,x1:t[l].x0,y0:t[l].y0,y1:t[l].y0+r(t[l]),heights:r(t[l])});return e}(n),t}},unrooted:{unrooted:function(n){var r={},e=t(function n(r){null===r.parent&&(r.start=0,r.end=2,r.angle=0,r.ntips=t(r),r.x=0,r.y=0);for(var e,a,i=r.start,l=0;l<r.children.length;l++)(e=r.children[l]).ntips=t(e),a=(r.end-r.start)*e.ntips/r.ntips,e.start=i,e.end=e.start+a,e.angle=e.start+(e.end-e.start)/2,i=e.end,e.x=r.x+e.branchLength*Math.sin(e.angle*Math.PI),e.y=r.y+e.branchLength*Math.cos(e.angle*Math.PI),n(e);return r}(n));return r.data=e,r.edges=t(e),r}},parentFisheye:t,readTree:t,subTree:t}}));
